<script>
    let startTime = Date.now();
    let estimatedTotalTime = 90000; // 90 seconds estimate
    let retryCount = 0;
    const maxRetries = 2;

    function updateProgress() {
        const elapsed = Date.now() - startTime;
        const progress = Math.min((elapsed / estimatedTotalTime) * 100, 95);
        
        document.getElementById('progressFill').style.width = progress + '%';
        
        // Update status messages based on progress
        const statusMessages = [
            { threshold: 25, text: 'Loading current month data...', action: 'ðŸ“Š Retrieving current financial statement' },
            { threshold: 50, text: 'Loading recent history...', action: 'ðŸ“… Gathering last 6 months of donor data' },
            { threshold: 75, text: 'Loading full history...', action: 'ðŸ“ˆ Collecting complete 12-month history' },
            { threshold: 100, text: 'Finalizing analysis...', action: 'ðŸ” Analyzing donor patterns and trends' }
        ];
        
        const currentStatus = statusMessages.find(status => progress < status.threshold) || statusMessages[3];
        document.getElementById('progressText').textContent = currentStatus.text;
        document.getElementById('currentAction').textContent = currentStatus.action;
        
        // Show time elapsed
        const secondsElapsed = Math.floor(elapsed / 1000);
        document.getElementById('statusMessage').innerHTML = 
            `Gathering 12 months of financial history from BIMI.<br>
             <small>Elapsed time: ${secondsElapsed} seconds</small>`;
    }

    async function loadData() {
        try {
            console.log('Starting data load...');
            const response = await fetch('/load-data');
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('Load data response:', data);
            
            if (data.status === 'complete') {
                // Complete - redirect to dashboard with cache busting
                document.getElementById('progressFill').style.width = '100%';
                document.getElementById('progressText').textContent = 'Complete! Redirecting...';
                document.getElementById('currentAction').textContent = 'âœ… Data loaded successfully';
                
                // Force a hard redirect
                setTimeout(() => {
                    window.location.href = '/dashboard?t=' + Date.now();
                }, 1500);
            } else if (data.status === 'error') {
                throw new Error(data.message);
            } else {
                throw new Error('Unknown response from server');
            }
        } catch (error) {
            console.error('Loading error:', error);
            
            if (retryCount < maxRetries) {
                retryCount++;
                document.getElementById('progressText').textContent = `Retrying... (${retryCount}/${maxRetries})`;
                document.getElementById('currentAction').textContent = 'ðŸ”„ Connection issue, retrying...';
                
                setTimeout(loadData, 3000);
            } else {
                document.getElementById('progressText').textContent = 'Error loading data';
                document.getElementById('currentAction').textContent = 'âŒ Failed to load data. Please try refreshing.';
                document.getElementById('progressFill').style.backgroundColor = '#ff6b6b';
                document.getElementById('statusMessage').innerHTML = 
                    `Error: ${error.message}<br>
                     <button onclick="window.location.href='/dashboard'" style="margin-top: 10px; padding: 8px 16px; background: white; color: #667eea; border: none; border-radius: 4px; cursor: pointer;">
                         Try Dashboard Anyway
                     </button>`;
            }
        }
    }

    // Start everything when page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Start progress updates
        const progressInterval = setInterval(updateProgress, 500);
        
        // Start data loading after a brief delay
        setTimeout(loadData, 1000);
    });
</script>
